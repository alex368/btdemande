{% extends 'base.html.twig' %}

{% block title %}Assistant Chat{% endblock %}

{% block body %}
<style>
  .chat-container { height: 105vh; display: flex; flex-direction: column; }
  .chat-header { padding: 1rem 1.5rem; border-bottom: 1px solid #dee2e6; background: #fff; }
  .chat-messages { flex-grow: 1; overflow-y: auto; padding: 1rem 1.5rem; display: flex; flex-direction: column; gap: 1rem; background: #f8f9fa; }
  .chat-message { max-width: 75%; padding: 0.75rem 1rem; border-radius: 20px; word-break: break-word; line-height: 1.35; }
  .chat-message.assistant { background-color: #166a5d; color: white; border-bottom-right-radius: 0; align-self: flex-start; }
  .chat-message.user { background-color: #198754; color: white; border-bottom-left-radius: 0; align-self: flex-end; }
  .chat-input { padding: 1rem 1.5rem; border-top: 1px solid #dee2e6; background: #fff; }

  /* Markdown render */
  .chat-message.assistant p { margin: 0 0 0.6rem 0; }
  .chat-message.assistant p:last-child { margin-bottom: 0; }
  .chat-message.assistant ul { margin: 0.5rem 0 0.5rem 1.2rem; }
  .chat-message.assistant code { background: rgba(0,0,0,0.15); padding: 2px 6px; border-radius: 8px; color: #fff; }
  .chat-message.assistant pre { background: rgba(0,0,0,0.18); padding: 10px 12px; border-radius: 12px; overflow-x: auto; margin: 0.6rem 0; }

  /* Actions / links */
  .ai-links { margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.25); display: flex; flex-wrap: wrap; gap: 8px; }
  .ai-links a { display: inline-flex; align-items: center; gap: 6px; font-size: 0.9rem; padding: 6px 10px; border-radius: 10px; background: rgba(0,0,0,0.18); color: #fff; text-decoration: none; border: 1px solid rgba(255,255,255,0.18); }
  .ai-links a:hover { background: rgba(0,0,0,0.28); color: #fff; }
  .ai-links .badge-type { font-size: 0.75rem; padding: 2px 8px; border-radius: 999px; background: rgba(255,255,255,0.18); }

  /* Contact details */
  .ai-panel {
    margin-top: 10px;
    padding: 10px 12px;
    border-radius: 12px;
    background: rgba(0,0,0,0.14);
    border: 1px solid rgba(255,255,255,0.18);
  }
  .ai-panel h6 { margin: 0 0 8px 0; font-weight: 700; font-size: 0.95rem; }
  .ai-panel .meta { font-size: 0.88rem; opacity: 0.95; }
  .ai-panel .list { margin-top: 8px; display: grid; gap: 6px; }
  .ai-panel .item {
    padding: 8px 10px;
    border-radius: 10px;
    background: rgba(0,0,0,0.14);
    border: 1px solid rgba(255,255,255,0.12);
    font-size: 0.88rem;
  }
  .ai-panel .item b { font-weight: 700; }
</style>

<div class="col-lg-12 chat-container" id="chat-root">
  <div class="chat-header">
    <h2 class="fw-bold mb-0 d-flex align-items-center">
      Assistant <span class="badge bg-warning text-dark ms-2">Bêta</span>
    </h2>
    <p class="text-muted mb-0">Pose ta question, je réponds directement.</p>
  </div>

  <div class="chat-messages" id="chat-messages">
    <div class="chat-message assistant">
      Bonjour. Je suis prêt. Envoie ta question.
    </div>
  </div>

  <div class="chat-input">
    <form id="chat-form" class="d-flex align-items-center w-100 gap-2 flex-nowrap">
      <input
        type="text"
        name="question"
        class="form-control rounded-0 px-4"
        placeholder="Pose ta question ici..."
        required
        autocomplete="off"
      >
      <button
        type="submit"
        class="btn btn-primary rounded-0 d-flex align-items-center justify-content-center"
        style="width: 48px; height: 48px;"
        aria-label="Envoyer"
      >
        <i class="bi bi-send-fill"></i>
      </button>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("chat-form");
  const input = form.querySelector("input[name='question']");
  const messagesContainer = document.getElementById("chat-messages");

  const CONTACT_ID = {{ contactId is defined ? contactId|json_encode|raw : 'null' }};
  const ENDPOINT = CONTACT_ID ? `/api/chat-ai/contact/${CONTACT_ID}` : "/api/chat-ai";

  function scrollToBottom() {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  function addMessage(text, sender) {
    const div = document.createElement("div");
    div.classList.add("chat-message", sender);
    div.textContent = String(text || "");
    messagesContainer.appendChild(div);
    scrollToBottom();
    return div;
  }

  function animateThinking(el) {
    let dots = 0;
    return setInterval(() => {
      dots = (dots + 1) % 4;
      el.textContent = "Je réfléchis" + ".".repeat(dots);
    }, 400);
  }

  // ✅ Supprime le lien de fiche si jamais il apparaît, garde l'email
  function sanitizeAnswer(text) {
    const t = String(text || "");
    return t
      .split("\n")
      .filter(line => !line.trim().toLowerCase().startsWith("fiche :"))
      .join("\n")
      .trim();
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const question = input.value.trim();
    if (!question) return;

    addMessage(question, "user");
    input.value = "";
    input.focus();

    const botMsg = addMessage("Je réfléchis", "assistant");
    const thinkingInterval = animateThinking(botMsg);

    try {
const res = await fetch(ENDPOINT, {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    "Accept": "application/json"
  },
  body: JSON.stringify({ question })
});

const contentType = res.headers.get("content-type") || "";
const rawText = await res.text();

let data = {};
if (contentType.includes("application/json")) {
  try { data = rawText ? JSON.parse(rawText) : {}; } catch { data = {}; }
} else {
  data = { error: "Réponse serveur non-JSON", details: rawText.slice(0, 1200) };
}


      clearInterval(thinkingInterval);

      if (!res.ok || data.error) {
        botMsg.textContent = "⚠️ " + (data.error || "Erreur serveur.");
        if (data.details) console.error("Server details:", data.details);
        return;
      }

      botMsg.textContent = sanitizeAnswer(data.answer || "");
      scrollToBottom();

    } catch (err) {
      clearInterval(thinkingInterval);
      botMsg.textContent = "⚠️ Erreur réseau.";
      console.error(err);
    }
  });

  scrollToBottom();
});
</script>


{% endblock %}
