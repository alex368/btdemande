{% extends 'base.html.twig' %}

{% block title %}Ajouter un devis{% endblock %}

{% block body %}

<main class="col-md-12 col-lg-12 p-2">
<div class="container mt-5">

    <h1 class="text-center bebas text-color-blue mb-5 mt-5">Ajouter un devis</h1>

    {{ form_start(form) }}

    {# =============================
       INFORMATION DU DEVIS
    ============================== #}
    <div class="card shadow-sm p-4 mb-4">
        <h5 class="fw-bold mb-3">Informations du devis</h5>
        {{ form_row(form.quoteNumber) }}
        {{ form_row(form.expirationDate) }}
        {{ form_row(form.createdAt) }}
    </div>

    {# =============================
       PROTOTYPE (Important)
    ============================== #}
    {% set quoteItemPrototype %}
        <div class="quote-item card shadow-sm p-4 mb-4">

            <h5 class="fw-bold mb-3">Ligne produit</h5>

            {{ form_row(form.quoteItems.vars.prototype.productService) }}

          

            <hr>

            <div class="add-on-block mt-3">
                <h6 class="fw-bold">Produits compl√©mentaires</h6>

                <div class="add-on-items"
                     data-prototype="{{ form_widget(form.quoteItems.vars.prototype.addOnProducts.vars.prototype)|e('html_attr') }}"
                     data-index="0">
                </div>

                <button type="button" class="btn btn-outline-success btn-sm mt-2 add-add-on">
                    <i class="bi bi-plus-circle"></i> Ajouter un produit compl√©mentaire
                </button>
            </div>
              <div class="mt-3 calculation-summary text-primary fw-bold">
                Montant estimatif accompagnement : <span class="unit-total">0.00 ‚Ç¨</span>
            </div>

            <button type="button" class="btn btn-danger btn-sm remove-quote-item mt-4">
                <i class="bi bi-trash"></i> Supprimer la ligne
            </button>
        </div>
    {% endset %}

    {# =============================
       LISTE DES LIGNES DEVIS
    ============================== #}
    <div class="card shadow-sm p-4 mb-4">
        <h5 class="fw-bold mb-3">Produits / Services</h5>

        <div id="quote-items"
             data-prototype="{{ quoteItemPrototype|e('html_attr') }}"
             data-index="{{ form.quoteItems|length }}">

            {% for item in form.quoteItems %}
                <div class="quote-item card shadow-sm p-4 mb-4">

                    <h5 class="fw-bold mb-3">Ligne produit</h5>

                    {{ form_row(item.productService) }}

                    <div class="mt-3 calculation-summary text-primary fw-bold">
                        Total prestation : <span class="unit-total">0.00 ‚Ç¨</span>
                    </div>

                    <hr>

                    <div class="add-on-block mt-3">
                        <h6 class="fw-bold">Produits compl√©mentaires</h6>

                        <div class="add-on-items"
                             data-prototype="{{ form_widget(item.addOnProducts.vars.prototype)|e('html_attr') }}"
                             data-index="{{ item.addOnProducts|length }}">

                            {% for addOn in item.addOnProducts %}
                                <div class="add-on-item border p-3 rounded mb-2">
                                    {{ form_widget(addOn) }}
                                    <button type="button" class="btn btn-danger btn-sm remove-add-on mt-2">
                                        <i class="bi bi-trash"></i> Supprimer
                                    </button>
                                </div>
                            {% endfor %}
                        </div>

                        <button type="button" class="btn btn-outline-success btn-sm mt-2 add-add-on">
                            <i class="bi bi-plus-circle"></i> Ajouter un produit compl√©mentaire
                        </button>
                    </div>

                    <button type="button" class="btn btn-danger btn-sm remove-quote-item mt-4">
                        <i class="bi bi-trash"></i> Supprimer la ligne
                    </button>

                </div>
            {% endfor %}

        </div>

        <button id="add-item" type="button" class="btn btn-outline-primary mt-3">
            <i class="bi bi-plus-circle"></i> Ajouter une ligne
        </button>

    </div>


    {# =============================
       TOTAL GLOBAL
    ============================== #}
    <div class="card shadow-sm p-3 mt-4">
        <h5 class="fw-bold mb-2">Total HT du devis</h5>
        <div class="fs-4 text-success fw-bold" id="global-total">0.00 ‚Ç¨</div>
    </div>

    <button class="btn btn-primary btn-lg mt-4">Cr√©er le devis</button>

    {{ form_end(form) }}

</div>
</main>

{# ===========================================================
   SCRIPT ‚Äî CALCUL EN TEMPS R√âEL SANS QUANTIT√â
=========================================================== #}
<script>

// Calcule une ligne (uniquement les addOns)
function calculateLine(quoteItem) {

    let addonsTotal = 0;

    quoteItem.querySelectorAll('.add-on-item').forEach(addon => {

        const priceInput = addon.querySelector('.addon-price');
        const pctInput   = addon.querySelector('.addon-percentage');

        const price = priceInput ? parseFloat(priceInput.value) || 0 : 0;
        const pct   = pctInput ? parseFloat(pctInput.value) || 0 : 0;

        addonsTotal += price * (pct / 100);
    });

    // Mise √† jour affichage
    const display = quoteItem.querySelector('.unit-total');
    if (display) {
        display.textContent = addonsTotal.toFixed(2) + ' ‚Ç¨';
    }

    return addonsTotal;
}


// TOTAL GLOBAL
function calculateGlobalTotal() {
    let total = 0;

    document.querySelectorAll('.quote-item').forEach(item => {

        // 1Ô∏è‚É£ Total addons (calcul√© dans calculateLine)
        const addonsTotal = calculateLine(item);

        // 2Ô∏è‚É£ Prix du produit principal
        let productPrice = 0;
        const select = item.querySelector('.product-price-selector');

        if (select) {
            const selected = select.selectedOptions[0];
            productPrice = selected && selected.dataset.price
                ? parseFloat(selected.dataset.price)
                : 0;
        }

        // 3Ô∏è‚É£ Vous additionnez produit principal + addons
        total += productPrice + addonsTotal;
    });

    // 4Ô∏è‚É£ Affichage
    const global = document.getElementById('global-total');
    if (global) {
        global.textContent = total.toFixed(2) + ' ‚Ç¨';
    }
}


// üîÑ Mise √† jour en temps r√©el
document.addEventListener('input', function (e) {

    if (
        e.target.classList.contains('addon-price') ||
        e.target.classList.contains('addon-percentage') ||
        e.target.classList.contains('product-price-selector') // ‚Üê IMPORTANT
    ) {
        calculateGlobalTotal();
    }
});

// Supporte aussi les changements de s√©lection (s√©lecteurs)
document.addEventListener('change', function (e) {

    if (e.target.classList.contains('product-price-selector')) {
        calculateGlobalTotal();
    }

});


// ‚ûï / ‚ûñ Gestion des add-ons et lignes
document.addEventListener('click', function (event) {

    // Ajouter ligne
    if (event.target.id === 'add-item') {

        const container = document.getElementById('quote-items');
        const index = container.dataset.index;
        const prototype = container.dataset.prototype.replace(/__name__/g, index);

        const wrapper = document.createElement('div');
        wrapper.innerHTML = prototype;
        container.appendChild(wrapper.firstElementChild);

        container.dataset.index = parseInt(index) + 1;

        setTimeout(calculateGlobalTotal, 50);
    }

    // Supprimer ligne
    if (event.target.classList.contains('remove-quote-item')) {
        event.target.closest('.quote-item').remove();
        calculateGlobalTotal();
    }

    // Ajouter AddOn
    if (event.target.classList.contains('add-add-on')) {

        const block = event.target.closest('.add-on-block');
        const itemsContainer = block.querySelector('.add-on-items');
        const index = itemsContainer.dataset.index;
        const prototype = itemsContainer.dataset.prototype.replace(/__name__/g, index);

        const wrapper = document.createElement('div');
        wrapper.innerHTML = prototype;

        const addOn = wrapper.firstElementChild;
        addOn.classList.add('add-on-item','border','p-3','rounded','mb-2');

        addOn.insertAdjacentHTML('beforeend', `
            <button type="button" class="btn btn-danger btn-sm remove-add-on mt-2">
                <i class="bi bi-trash"></i> Supprimer
            </button>
        `);

        itemsContainer.appendChild(addOn);
        itemsContainer.dataset.index = parseInt(index) + 1;

        setTimeout(calculateGlobalTotal, 50);
    }

    // Supprimer AddOn
    if (event.target.classList.contains('remove-add-on')) {
        event.target.closest('.add-on-item').remove();
        calculateGlobalTotal();
    }

});

document.addEventListener('DOMContentLoaded', calculateGlobalTotal);

</script>



{% endblock %}
